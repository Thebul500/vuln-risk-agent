name: Semgrep SAST

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    - cron: "0 3 * * 0"  # Sunday 3 AM UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  security-events: write
  issues: write

jobs:
  semgrep-scan:
    name: Semgrep Scan
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    outputs:
      has_findings: ${{ steps.parse.outputs.has_findings }}
      has_autofixes: ${{ steps.parse.outputs.has_autofixes }}
      findings_count: ${{ steps.parse.outputs.findings_count }}
    steps:
      - uses: actions/checkout@v4

      - name: Run Semgrep (SARIF)
        run: |
          semgrep scan \
            --config auto \
            --config p/security-audit \
            --config p/owasp-top-ten \
            --config p/secrets \
            --sarif \
            --output semgrep-results.sarif \
            --error
        continue-on-error: true

      - name: Run Semgrep (JSON)
        run: |
          semgrep scan \
            --config auto \
            --config p/security-audit \
            --config p/owasp-top-ten \
            --config p/secrets \
            --json \
            --output semgrep-results.json
        continue-on-error: true

      - name: Parse findings
        id: parse
        shell: sh
        run: |
          if [ ! -f semgrep-results.json ]; then
            echo "has_findings=false" >> "$GITHUB_OUTPUT"
            echo "has_autofixes=false" >> "$GITHUB_OUTPUT"
            echo "findings_count=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          TOTAL=$(cat semgrep-results.json | python3 -c "import sys,json; print(len(json.load(sys.stdin).get('results',[])))")
          AUTOFIXES=$(cat semgrep-results.json | python3 -c "import sys,json; print(len([r for r in json.load(sys.stdin).get('results',[]) if r.get('extra',{}).get('fix')]))")
          echo "findings_count=${TOTAL}" >> "$GITHUB_OUTPUT"
          if [ "$TOTAL" -gt 0 ]; then
            echo "has_findings=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_findings=false" >> "$GITHUB_OUTPUT"
          fi
          if [ "$AUTOFIXES" -gt 0 ]; then
            echo "has_autofixes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_autofixes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep-results.sarif
        continue-on-error: true

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: semgrep-results.json
          retention-days: 30

      - name: Create issue for high/critical findings
        if: always()
        shell: python3 {0}
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          import json, os, sys, urllib.request, urllib.error

          try:
              with open("semgrep-results.json") as f:
                  data = json.load(f)
          except (FileNotFoundError, json.JSONDecodeError):
              print("No results file found, skipping issue creation")
              sys.exit(0)

          severity_map = {"ERROR": "HIGH", "WARNING": "MEDIUM", "INFO": "LOW"}

          findings = []
          for r in data.get("results", []):
              sev = r.get("extra", {}).get("severity", "INFO")
              level = severity_map.get(sev, sev)
              if level not in ("HIGH", "CRITICAL"):
                  continue
              findings.append({
                  "rule": r.get("check_id", "unknown"),
                  "severity": level,
                  "file": r.get("path", "?"),
                  "line": r.get("start", {}).get("line", "?"),
                  "message": r.get("extra", {}).get("message", "No description"),
              })

          if not findings:
              print("No high/critical findings, no issue needed")
              sys.exit(0)

          token = os.environ["GH_TOKEN"]
          repo = os.environ["REPO"]
          api = f"https://api.github.com/repos/{repo}"
          headers = {
              "Authorization": f"token {token}",
              "Accept": "application/vnd.github.v3+json",
              "Content-Type": "application/json",
          }

          title = f"Semgrep: {len(findings)} high/critical finding(s) detected"

          body_lines = [
              f"Semgrep found **{len(findings)} high/critical** security finding(s).",
              "",
              f"**Workflow run:** {os.environ['RUN_URL']}",
              "",
              "| Severity | File | Line | Rule | Description |",
              "|----------|------|------|------|-------------|",
          ]
          for finding in findings:
              msg = finding["message"].replace("\n", " ")[:120]
              body_lines.append(
                  f'| {finding["severity"]} | `{finding["file"]}` | {finding["line"]} | `{finding["rule"]}` | {msg} |'
              )
          body_lines += ["", "---", "*Auto-generated by Semgrep SAST workflow*"]
          body = "\n".join(body_lines)

          def api_request(url, data=None, method="GET"):
              req = urllib.request.Request(url, headers=headers, method=method)
              if data:
                  req.data = json.dumps(data).encode()
              try:
                  with urllib.request.urlopen(req) as resp:
                      return json.loads(resp.read())
              except urllib.error.HTTPError as e:
                  print(f"API error {e.code}: {e.read().decode()}")
                  return None

          # Check for existing open issue with same title
          search_url = f"https://api.github.com/search/issues?q={urllib.request.quote(title)}+repo:{repo}+state:open+type:issue"
          result = api_request(search_url)
          if result and result.get("total_count", 0) > 0:
              for issue in result["items"]:
                  if issue["title"] == title:
                      comment_url = f"{api}/issues/{issue['number']}/comments"
                      api_request(comment_url, {"body": body}, "POST")
                      print(f"Updated existing issue #{issue['number']}")
                      sys.exit(0)

          # Create new issue
          issue_data = {"title": title, "body": body, "labels": ["security"]}
          new_issue = api_request(f"{api}/issues", issue_data, "POST")
          if new_issue:
              print(f"Created issue #{new_issue.get('number')}: {title}")
          else:
              print("Failed to create issue")
              sys.exit(1)

  semgrep-autofix:
    name: Semgrep Autofix
    needs: semgrep-scan
    if: needs.semgrep-scan.outputs.has_autofixes == 'true' && github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Semgrep
        run: pip install semgrep

      - name: Apply autofixes
        run: |
          semgrep scan \
            --config auto \
            --config p/security-audit \
            --config p/owasp-top-ten \
            --config p/secrets \
            --autofix .
        continue-on-error: true

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "changed_files=$(git diff --name-only | wc -l)" >> "$GITHUB_OUTPUT"
          fi

      - name: Detect and run tests
        id: tests
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          TEST_RESULT="no_tests"
          if [ -f "package.json" ] && grep -q '"test"' package.json; then
            TEST_CMD=$(python3 -c "import json; d=json.load(open('package.json')); print(d.get('scripts',{}).get('test',''))" 2>/dev/null || echo "")
            if echo "$TEST_CMD" | grep -qi 'echo.*error\|no test\|exit 1'; then
              echo "Placeholder test script, skipping"
              TEST_RESULT="no_tests"
            else
              npm install --ignore-scripts --no-audit --no-fund 2>/dev/null || true
              if npm test; then
                TEST_RESULT="passed"
              else
                TEST_RESULT="failed"
              fi
            fi
          elif [ -f "pytest.ini" ] || [ -f "setup.py" ] || [ -f "pyproject.toml" ]; then
            pip install -e . 2>/dev/null || true
            pip install pytest 2>/dev/null || true
            if pytest; then
              TEST_RESULT="passed"
            else
              TEST_RESULT="failed"
            fi
          elif [ -f "Cargo.toml" ]; then
            if cargo test; then
              TEST_RESULT="passed"
            else
              TEST_RESULT="failed"
            fi
          elif [ -f "go.mod" ]; then
            if go test ./...; then
              TEST_RESULT="passed"
            else
              TEST_RESULT="failed"
            fi
          fi
          echo "test_result=${TEST_RESULT}" >> "$GITHUB_OUTPUT"

      - name: Create autofix PR
        if: steps.changes.outputs.has_changes == 'true' && steps.tests.outputs.test_result != 'failed'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE_TAG=$(date +%Y-%m-%d)
          BRANCH="semgrep/autofix-${DATE_TAG}-${GITHUB_RUN_NUMBER}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add -A
          git commit -m "fix: apply Semgrep security autofixes (${DATE_TAG})

          Autofixes applied by Semgrep scan.
          Files modified: ${{ steps.changes.outputs.changed_files }}
          Tests: ${{ steps.tests.outputs.test_result }}

          Automated by Semgrep SAST workflow"

          git push origin "$BRANCH"

          PR_URL=$(gh pr create \
            --title "fix: Semgrep security autofixes (${DATE_TAG})" \
            --body "## Semgrep Auto-Fix

          Automated security fixes applied by Semgrep.

          **Files modified:** ${{ steps.changes.outputs.changed_files }}
          **Test result:** ${{ steps.tests.outputs.test_result }}
          **Rulesets:** auto, security-audit, owasp-top-ten, secrets

          ---
          *Automated by Semgrep SAST workflow*")

          echo "PR created: $PR_URL"

          # Enable auto-merge if available
          gh pr merge --auto --merge "$PR_URL" 2>/dev/null || echo "Auto-merge not available"

  notify:
    name: Notify Results
    needs: [semgrep-scan, semgrep-autofix]
    if: always() && github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Send webhook to n8n
        run: |
          curl -s -X POST "https://n8n.bul-network.com:9443/webhook/semgrep-ci-results" \
            -H "Content-Type: application/json" \
            -d "{
              \"repo\": \"${{ github.repository }}\",
              \"run_url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
              \"findings_count\": ${{ needs.semgrep-scan.outputs.findings_count || 0 }},
              \"has_autofixes\": ${{ needs.semgrep-scan.outputs.has_autofixes || false }},
              \"event\": \"${{ github.event_name }}\",
              \"timestamp\": \"$(date -Iseconds)\"
            }" || echo "Webhook delivery failed (n8n may be unreachable)"
